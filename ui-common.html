<script>
/**
 * Debug mode
 */
const DEBUG = false;

if (DEBUG) {
  window.onerror = function (msg, url, line, col, err) {
    console.group('%c[window.onerror]', 'color:#b00;font-weight:bold');
    console.log('message:', msg);
    console.log('url    :', url);
    console.log('line   :', line, 'col:', col);
    console.log('error  :', err && (err.stack || err));
    console.groupEnd();
  };
  window.onunhandledrejection = function (e) {
    console.group('%c[unhandledrejection]', 'color:#b00;font-weight:bold');
    console.log('reason:', e.reason);
    console.groupEnd();
  };
}

/**
 * CSS.escape Polyfill -less environment (simple, safe version)
 */
if (typeof CSS === 'undefined') window.CSS = {};
if (typeof CSS.escape !== 'function') {
  CSS.escape = function (s) {
    return String(s).replace(/[\0-\x1F\x7F]|^-?\d|[^a-zA-Z0-9_-]/g, function (ch) {
      return '\\' + ch.charCodeAt(0).toString(16) + ' ';
    });
  };
}

// フォールバック付き翻訳ヘルパ
function t(key, fallback) {
  var dict = (window.I18N || {});
  return (dict && dict[key]) || (fallback || key);
}

// data-i18n に指定されたキーを一括適用（textのみ）
function applyI18n() {
  var dict = (window.I18N || {});
  if (!dict || !Object.keys(dict).length) return;
  document.querySelectorAll('[data-i18n]').forEach(function(el){
    var key = el.getAttribute('data-i18n');
    if (dict[key]) el.textContent = dict[key];
  });
}

/**
 * HTML escape common function
 * @param {string} s
 * @returns {string}
 */
function esc(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/**
 * Show Status
 * @param String msg
 * @return Void
 */
function showStatus(msg) {
  if (msg == "") return;
  google.script.run.showAlert(msg);
}

/**
 * Show Status and turn off its progress
 * @param String msg
 * @param String buttonId
 * @return Void
 */
function showStatusAndFin(msg, buttonId) {
  if (msg == "") return;
  google.script.run
    .withSuccessHandler(
      function(ret) {
        progressIndicator(ret['buttonId'], 'progress-'+ret['buttonId'], false);
      })
    .withFailureHandler(
      function(ret) {
        progressIndicator(ret['buttonId'], 'progress-'+ret['buttonId'], false);
      })
    .showAlert(msg, buttonId);
}

/**
 * progress indicator
 * @param String buttonId
 * @param String indicatorId
 * @param Bool on
 * @return Void
 */
function progressIndicator(buttonId, indicatorId, on) {
  if (on) {
    $('#'+buttonId).prop('disabled', true);
    if (indicatorId) {
      var msg = Object.keys(lang.ui).length == 0 ? 'in progress' : lang.ui['in-progress'];
      $('#'+indicatorId).show();
      $('#'+indicatorId).html('<span class="skip">'+msg+'</span>');
    }
  } else {
    $('#'+buttonId).prop('disabled', false);
    if (indicatorId) {
      $('#'+indicatorId).hide();
      $('#'+indicatorId).html('');
    }
  }
}
</script>

<style>
body
{
  padding: 10px;
}

details
{
  padding: 10px;
  border:1px #eee solid;
  margin-bottom: 10px;
}

summary
{
  font-weight: bold;
}

summary:hover,
input[type=button],
button
{
  cursor: pointer;
}

.skip
{
 position: absolute !important;
 width: 1px !important;
 height: 1px !important;
 margin: -1px !important;
 padding: 0 !important;
 border: 0 !important;
 overflow: hidden !important;
 clip: rect(0 0 0 0) !important;
 clip-path: inset(50%) !important;
 white-space: nowrap !important;
}

*:focus
{
  outline: solid !important;
}

kbd
{
  display: inline-block;
  padding: 3px;
  border: 1px #aaa solid;
}

#control-icl,
#evaluate-icl
{
  display: none;
}
</style>