<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    /**
     * lang
     */
    var lang = {};

    /**
     * events
     */
    $(function() {
      // UI
      google.script.run
        .withSuccessHandler(
          function(ui) {
            // English
            if (Object.keys(ui).length == 0) {
              lang.ui = {};
              return;
            }
            
            // other languages
            // ui['lang'] is exist. if button width must be changed. use this variable.
            lang.ui = ui;
            $("#show-config").html(ui['config']);
            $("#show-examination").html(ui['examination']);
            $("#show-report").html(ui['report']);
            $("#value-title").html(ui['value']);
            $("#set-additional-criteria").html(ui['set-additional-criteria']);
            $("#test-type-title").html(ui['test-type']);
            $("#urls-title").html(ui['sheet-control']);
            $("#generate-sheets").html(ui['generate']);
            $("#control-sheets").html(ui['get-sheets']);
            $("#delete-sheets-title").html(ui['delete']);
            $("#screenshot-title").html(ui['screenshot']);
            $("#add-screenshot").html(ui['add-screenshot']);
            $("#config-title").html(ui['config']);
            $("#genarate-config").html(ui['generate-config-sheet']);
            $("#insert-techniques-title").html(ui['insert-techniques-sheet']);
            $("#do-insert-tech").html(ui['insert-techniques-sheet']);
            $("#select-check-title").html(ui['select-check']);
            $("#do-set-all-to-t").html(ui['set-all-to-t']);
            $("#template-title").html(ui['template']);
            $("#do-template-apply-all").html(ui['apply-tpl-all']);
            $("#do-template-apply-row").html(ui['apply-tpl-row']);
            $("#generate-template").html(ui['generate-template']);
            $("#template-caution").html(ui['template-caution']);
            $("#issue-control-title").html(ui['issue-control-title']);
            $("#add-edit-issue").html(ui['add-edit-issue']);
            $("#show-issue").html(ui['show-issue']);
            $("#export-html-title").html(ui['export-html-title']);
            $("#export-html").html(ui['export-html']);
            $("#export-issue").html(ui['export-issues']);
            $("#evaluate-title").html(ui['evaluate']);
            $("#do-evaluate").html(ui['do-evaluate']);
            $("#do-evaluate-icl").html(ui['do-evaluate-icl']);
          })
        .getLangSet('ui');

      // on load
      $('#template-caution').hide();
      $('#message-area').hide();
      $('#pannel-examination').hide();
      $('#pannel-report').hide();

      // on change
      $('#test-type').change(changeTestType);
      $('#delete-sheets').change(changeControlStatus);

      // on click
      $('#generate-sheets').bind('click', {sheets:"*urls*", targetId:'#generate-sheets'}, onGenerateSheetClick);
      $('#generate-template').bind('click', {sheets:"*Template*", targetId:'#generate-template'}, onGenerateSheetClick);
      $('#set-additional-criteria').click(onSetAdditionalCriteriaClick);
      $('#control-sheets').click(onControlSheetClick);
      $('#do-evaluate').click(onEvaluateClick);
      $('#do-evaluate-icl').click(onEvaluateIclClick);
      $('#do-set-all-to-t').click(onDoSetAllToTClick);
      $('#do-template-apply-all').click(onDoTemplateApplyAllClick);
      $('#do-template-apply-row').click(onDoTemplateApplyRowClick);
      $('#do-insert-tech').click(onShowTechDialogClick);
      $('#add-edit-issue').click(onAddIssueClick);
      $('#show-issue').click(onShowIssueClick);
      $('#export-issue').click(onExportIssueClick);
      $('#export-html').click(onExportHtmlClick);
      $('#export-icl-html').click(onExportIclHtmlClick);
      $('#add-screenshot').click(onAddScreenshotClick);
      $('#genarate-config').click(onGenarateConfigClick);

      // menu
      $('#show-config').on(
        'click',
        function(){
          $('#show-config').addClass('blue');
          $('#show-examination').removeClass('blue');
          $('#show-report').removeClass('blue');
          $('#pannel-config').show();
          $('#pannel-examination').hide();
          $('#pannel-report').hide();
        }
      );
      $('#show-examination').on(
        'click',
        function(){
          $('#show-config').removeClass('blue');
          $('#show-examination').addClass('blue');
          $('#show-report').removeClass('blue');
          $('#pannel-config').hide();
          $('#pannel-examination').show();
          $('#pannel-report').hide();
        }
      );
      $('#show-report').on(
        'click',
        function(){
          $('#show-config').removeClass('blue');
          $('#show-examination').removeClass('blue');
          $('#show-report').addClass('blue');
          $('#pannel-config').hide();
          $('#pannel-examination').hide();
          $('#pannel-report').show();
        }
      );

      // ICL (Japanese Only)
      google.script.run
        .withSuccessHandler(
          function(ret) {
            if (ret != 'ja') {
              $('#do-evaluate-icl').hide();
            }
          })
        .getProp('lang');

      // default value
      setDefaultValue();
    });

    /**
     * set default value
     */
    function setDefaultValue() {
      google.script.run
        .withSuccessHandler(
          function(ret) {
            $("#lang").val(ret);
            $("html").attr('lang', ret);
          })
        .getProp('lang');

      google.script.run
        .withSuccessHandler(
          function(ret) {
            $("#test-type").val(ret);

            // select level depend on test-type
            if (ret.indexOf('wcag') >= 0) {
              google.script.run
                .withSuccessHandler(
                  function(innerRet) {
                    $("#evaluate-level").val(innerRet);
                  })
                .getProp('level');
            } else {
              $("#evaluate-level").val('AA');
              $("#evaluate-level").prop('disabled', true);
            }

            // generate select candidate of bulk criteria
            generateBulkCriteia();
          })
        .getProp('type');
    }

    /**
     * change test type
     */
    function changeTestType() {
      if ($('#test-type').val().indexOf('tt') != -1) {
        $('#evaluate-level').val('AA');
        $('#evaluate-level').prop('disabled', true);
      } else {
        $('#evaluate-level').prop('disabled', false);
      }
    }

    /**
     * Set Additional Criteria
     */
    function onSetAdditionalCriteriaClick() {
      $('#message-area').hide();
      google.script.run.setAdditionalCriteria($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Generate Sheets
     * @param Object sheetsObj
     */
    function onGenerateSheetClick(sheetsObj) {
      $('#message-area').hide();
      var sheets = sheetsObj.data.sheets == "*urls*" ? $('#urls').val() : sheetsObj.data.sheets;
      var targetId = sheetsObj.data.targetId;
      $(targetId).prop('disabled', true);

      google.script.run
        .withSuccessHandler(
          function(rets) {
            showStatus(rets['msg']);
            $(rets['targetId']).prop('disabled', false);
          })
        .withFailureHandler(
          function(rets) {
            showStatus(rets['msg'], 'error');
            $(rets['targetId']).prop('disabled', false);
          })
        .generateSheets(sheets, $('#lang').val(), $('#test-type').val(), $('#evaluate-level').val(), targetId);
    }

    /**
     * Generate Config Sheets
     */
    function onGenarateConfigClick() {
      $('#message-area').hide();

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg, 'error');
          })
        .generateConfigSheets($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Get All Sheets / Delete Selected Sheets
     */
    function onControlSheetClick() {
      $('#message-area').hide();

      if ($('#delete-sheets').prop('checked')) {
        google.script.run
          .withSuccessHandler(
            function(msg) {
              showStatus(msg);
            })
          .withFailureHandler(
            function(msg) {
              showStatus(msg, 'error');
            })
          .deleteSheets($('#urls').val());
      } else {
        google.script.run
          .withSuccessHandler(
            function(ret) {
              $("#urls").val(ret);
            })
          .withFailureHandler(
            function(msg) {
              showStatus(msg, 'error');
            })
          .getSheets();
      }
    }

    /**
     * Edit Value
     */
    function onDoSetAllToTClick() {
      $('#message-area').hide();
      var msg = Object.keys(lang.ui).length == 0 ? 'This Page\'s All "Check will be overwritten."' : lang.ui['this-pages-all-check-will-be-overwritten'];
      if (confirm(msg) === false) return;

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg, 'error');
          })
        .setAllToT($('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * show Tech dialog
     */
    function onShowTechDialogClick() {
      $('#message-area').hide();
      google.script.run
        .withSuccessHandler(
          function(criterion) {
            var msg1 = Object.keys(lang.ui).length == 0 ? 'No appropriate criterion found.' : lang.ui['no-criterion-found'];
            var msg2 = Object.keys(lang.ui).length == 0 ? 'Techniques for '+criterion : lang.ui['tech-for'].replace("%s", criterion);
            var title = criterion == '' ? msg1 : msg2 ;
            google.script.run.showDialog('tech', 500, 400, title);
          })
        .getFirstColumn();
    }

    /**
     * show Screenshot dialog
     */
    function onAddScreenshotClick() {
      $('#message-area').hide();
      var title = Object.keys(lang.ui).length == 0 ? 'Screenshot' : lang.ui['screenshot'];
      google.script.run.showDialog('screenshot', 300, 200, title);
    }

    /**
     * Add Issue
     */
    function onAddIssueClick() {
      $('#message-area').hide();
      google.script.run.addIssue($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Show Issue
     */
    function onShowIssueClick() {
      $('#message-area').hide();
      var title = Object.keys(lang.ui).length == 0 ? 'Issue List"' : lang.ui['issue-list'];
      google.script.run.showDialog('issuelist', 500, 400, title);
    }

    /**
     * Make same as template
     */
    function onDoTemplateApplyAllClick() {
      $('#message-area').hide();
      var msg = Object.keys(lang.ui).length == 0 ? 'CAUTION: All result will be overwritten.' : lang.ui['caution-using-template'];
      if (confirm(msg) === false) return;
      var msg = Object.keys(lang.ui).length == 0 ? 'Now overwriting' : lang.ui['now-overwriting'];
      showStatus(msg);

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg, 'error');
          })
        .templateApplyAll();
    }

    /**
     * Make same as template row
     */
    function onDoTemplateApplyRowClick() {
      $('#message-area').hide();
      var msg = Object.keys(lang.ui).length == 0 ? 'CAUTION: All result will be overwritten.' : lang.ui['caution-using-template'];
      if (confirm(msg) === false) return;
      var msg = Object.keys(lang.ui).length == 0 ? 'Now overwriting' : lang.ui['now-overwriting'];
      showStatus(msg);

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg, 'error');
          })
        .templateApplyRow();
    }

    /**
     * change control status
     */
    function changeControlStatus() {
      var deleteUi    = Object.keys(lang.ui).length == 0 ? 'DELETE"' : lang.ui['delete'];
      var getSheetsUi = Object.keys(lang.ui).length == 0 ? 'Get Sheets"' : lang.ui['get-sheets'];
      if ($('#delete-sheets').prop('checked')) {
        $('#urls').css({'color':'#ffffff', 'background-color':'#aaaaaa'});
        $('#control-sheets').html(deleteUi);
        $('#generate-sheets').prop('disabled', true);
      } else {
        $('#urls').css({'color':'#000000', 'background-color':'#ffffff'});
        $('#control-sheets').html(getSheetsUi);
        $('#generate-sheets').prop('disabled', false);
      }
    }

    /**
     * Evaluate
     */
    function onEvaluateClick() {
      $('#message-area').hide();
      $('#do-evaluate').prop('disabled', true);

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            $('#do-evaluate').prop('disabled', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg, 'error');
            $('#do-evaluate').prop('disabled', false);
          })
        .evaluate($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Evaluate ICL
     */
    function onEvaluateIclClick() {
      $('#message-area').hide();
      $('#do-evaluate-icl').prop('disabled', true);

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            $('#do-evaluate-icl').prop('disabled', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg, 'error');
            $('#do-evaluate-icl').prop('disabled', false);
          })
        .evaluateIcl($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Export HTML
     */
    function onExportHtmlClick() {
      $('#message-area').hide();
      $('#export-html').prop('disabled', true);

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            $('#export-html').prop('disabled', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg);
            $('#export-html').prop('disabled', false);
          })
        .exportHtml($('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Export ICL HTML
     */
    function onExportIclHtmlClick() {
      $('#message-area').hide();
      $('#export-icl-html').prop('disabled', true);

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            $('#export-icl-html').prop('disabled', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg);
            $('#export-icl-html').prop('disabled', false);
          })
        .exportIclHtml();
    }

    /**
     * Export Issue
     */
    function onExportIssueClick() {
      $('#message-area').hide();

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg);
          })
        .exportIssue();
    }

    /**
     * Show Status
     */
    function showStatus(msg, classId) {
      $('#message-area').show();
      $('#sidebar-status').removeClass().html(msg);
      if (classId) {
        $('#sidebar-status').addClass(classId);
      }
    }
  </script>
</head>

<body>
  <div class="sidebar branding-below">
    <button id="show-config" class="blue">Config</button>
    <button id="show-examination">Exam.</button>
    <button id="show-report">Report</button>
    <hr>

    <div id="pannel-config">
    <fieldset class="block">
      <legend id="test-type-title">Test type</legend>
      <select id="lang" title="Language" style="width:3.5em;min-width:3.5em;">
        <option value="en">en</option>
        <option value="ja">ja</option>
      </select>
      <select id="test-type" title="Test Type">
        <option value="wcag20">WCAG 2.0</option>
        <option value="wcag21">WCAG 2.1</option>
        <option value="tt20">Trusted Tester</option>
  <!--      <option value="tt21">Trusted Tester (WCAG 2.1)</option>-->
      </select>
      <select id="evaluate-level" title="Level" style="width:5em;min-width:5em;">
        <option value="A">A</option>
        <option value="AA">AA</option>
        <option value="AAA">AAA</option>
      </select>
      <p><button id="set-additional-criteria">Set additional criteria</button></p>
      <p><button id="genarate-config">Generate config sheet</button></p>
    </fieldset>

    <fieldset class="block">
      <legend><label for="urls" id="urls-title">Sheet control</label></legend>
      <textarea style="width:100%;" id="urls"></textarea>
      <button id="generate-sheets">Generate</button>
      <button id="control-sheets">Get sheets</button>
      <input type="checkbox" id="delete-sheets"><label id="delete-sheets-title" for="delete-sheets">Delete</label>
    </fieldset>
    
    <fieldset class="block">
      <legend id="template-title">Template</legend>
      <p><button id="generate-template">Generate template sheet</button></p>
      <p><button id="do-template-apply-all">Apply all</button></p>
      <p><button id="do-template-apply-row">Apply current row</button></p>
    </fieldset>
    </div>

    <div id="pannel-examination">
    <fieldset class="block">
      <legend id="value-title">Value</legend>
      <p><button id="add-screenshot">Add screenshot</button></p>
      <p><button id="do-set-all-to-t">Set all to 'T'</button></p>
      <p><button id="do-insert-tech">Insert Techs to sheet</button></p>
    </fieldset>
    </div>

    <div id="pannel-report">
    <fieldset class="block">
      <legend id="evaluate-title">Evaluate</legend>
      <p><button id="do-evaluate">Evaluate</button></p>
      <p><button id="do-evaluate-icl">Evaluate ICL</button></p>
    </fieldset>

    <fieldset class="block">
      <legend id="issue-control-title">Issue Control</legend>
      <p><button id="add-edit-issue">Add/Edit Issue</button></p>
      <p><button id="show-issue">Show Issue</button></p>
      <p><button id="export-issue">Export Issues</button></p>
    </fieldset>
    <fieldset class="block">
      <legend id="export-html-title">Export Report</legend>
      <button id="export-html">Export HTML</button>
    </fieldset>
    </div>

    <div id="message-area" style="margin-top:15px;background-color: #eeeeee;padding:5px;">
      <div id="sidebar-info"></div>
      <div id="sidebar-status"></div>
    </div>
  </div>
</body>

</html>
