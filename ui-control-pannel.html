<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    /**
     * lang
     */
    var lang = {};

    /**
     * events
     */
    $(function() {
      // UI
      google.script.run
        .withSuccessHandler(
          function(ui) {
            // English
            if (Object.keys(ui).length == 0) {
              lang.ui = {};
              return;
            }
            
            // other languages
            lang.ui = ui;
            $("#show-examination").html(ui['examination']);
            $("#show-report").html(ui['report']);
            $("#test-type-title").html(ui['test-type']);
            $("#title-icl").html(ui['icl']);
            $("#target-urls-setting").html(ui['target-urls-setting']);
            $("#title-value").html(ui['value']);
            $("#title-lump-edit").html(ui['lump-edit']);
            $("#title-template").html(ui['template']);
            $("#title-evaluate").html(ui['evaluate']);
            $("#set-additional-criterion").html(ui['set-additional-criterion']);
            $("#generate-each-record-sheets").html(ui['generate-each-record-sheets']);
            $("#generate-url-list-sheet").html(ui['generate-url-list-sheet']);
            $("#generate-icl-tpl-sheet").html(ui['generate-icl-tpl-sheet']);
            $("#apply-icl-tpl").html(ui['apply-icl-tpl']);
            $("#add-screenshot").html(ui['add-screenshot']);
            $("#do-set-all-t").html(ui['set-all-t']);
            $("#do-insert-tech").html(ui['insert-techniques-sheet']);
            $("#label-lump-val").html(ui['value']);
            $("#label-lump-pos-row").html(ui['pos-row']);
            $("#label-lump-pos-col").html(ui['pos-col']);
            $("#get-current-pos").html(ui['get-current-pos']);
            $("#do-lump-edit").html(ui['lump-edit']);
            $("#do-template-apply-all").html(ui['apply-tpl-all']);
            $("#do-template-apply-row").html(ui['apply-tpl-row']);
            $("#generate-template").html(ui['generate-template']);
            $("#title-issue-control").html(ui['title-issue-control']);
            $("#add-edit-issue").html(ui['add-edit-issue']);
            $("#show-issue").html(ui['show-issue']);
            $("#export-html-title").html(ui['export-html-title']);
            $("#export-result").html(ui['export-result']);
            $("#export-issue").html(ui['export-issues']);
            $("#do-evaluate").html(ui['do-evaluate']);
            $("#do-evaluate-icl").html(ui['do-evaluate-icl']);
          })
        .getLangSet('ui');

      // on load
      $('.fa-spinner').hide();

      // on change
      $('#test-type').change(swtichLevelWhenTtOrNot);
      $('#evaluate-level').change(switchAdditionalCriterion);

      // on click
      $('#generate-each-record-sheets').bind('click', {sheets:"*urls*", targetId:'generate-each-record-sheets'}, onClickGenerateSheet);
      $('#generate-template').bind('click', {sheets:"*Template*", targetId:'generate-template'}, onClickGenerateSheet);
      $('#generate-url-list-sheet').click(onClickGenarateUrlList);
      $('#generate-icl-tpl-sheet').click(onClickGenarateIclTpl);
      $('#apply-icl-tpl').click(onClickApplyIclTpl);
      $('#set-additional-criterion').click(onClickSetAdditionalCriterion);
      $('#do-template-apply-all').click(onClickDoTemplateApplyAll);
      $('#do-template-apply-row').click(onClickDoTemplateApplyRow);
      $('#do-insert-tech').click(onClickDoInsertTech);
      $('#do-set-all-t').click(onClickDoapplyAllToT);
      $('#get-current-pos').click(onClickGetCurrentPos);
      $('#do-lump-edit').click(onClickDoLumpEdit);
      $('#add-screenshot').click(onClickAddScreenshot);
      $('#add-edit-issue').click(onClickAddEditIssue);
      $('#show-issue').click(onClickShowIssue);
      $('#do-evaluate').click(onClickDoEvaluate);
      $('#do-evaluate-icl').click(onClickDoEvaluateIcl);
      $('#export-result').click(onClickExportResult);
      $('#export-issue').click(onClickExportIssue);
      $('#reset-sheets').bind('click', {isAll:true}, onClickResetSheets);
      $('#reset-record-sheets').bind('click', {isAll:false}, onClickResetSheets);

      // ICL (Japanese Only)
      google.script.run
        .withSuccessHandler(
          function(ret) {
            if (ret == 'ja') {
              $('#do-evaluate-icl').show();
              $('#control-icl').show();
            }
          })
        .getProp('lang');

      // debug mode
      google.script.run
        .withSuccessHandler(
          function(ret) {
            if (ret) {
              $('#dev').show();
            }
          })
        .isDebug();
                
      // default value
      setDefaultValue();
    });

    /**
     * set default value
     */
    function setDefaultValue() {
      google.script.run
        .withSuccessHandler(
          function(ret) {
            $("#lang").val(ret);
            $("html").attr('lang', ret);
          })
        .getProp('lang');

      google.script.run
        .withSuccessHandler(
          function(ret) {
            $("#test-type").val(ret);

            // select level depend on test-type
            if (ret.indexOf('wcag') >= 0) {
              google.script.run
                .withSuccessHandler(
                  function(innerRet) {
                    $("#evaluate-level").val(innerRet);
                  })
                .getProp('level');
            } else {
              $("#evaluate-level").val('AA');
              $("#evaluate-level").prop('disabled', true);
              $('#do-evaluate-icl').hide();
              $('#control-icl').hide();
            }

            // generate select candidate of bulk criteria
            generateBulkCriteia();
          })
        .getProp('type');
    }

    /**
     * switch level value and status
     * Trusted Tester is fixed with AA
     */
    function swtichLevelWhenTtOrNot() {
      if ($('#test-type').val().indexOf('tt') != -1) {
        $('#control-icl').hide();
        $('#do-evaluate-icl').hide();
        $('#evaluate-level').val('AA');
        $('#evaluate-level').prop('disabled', true);
      } else {
        $('#control-icl').show();
        $('#do-evaluate-icl').show();
        $('#evaluate-level').prop('disabled', false);
      }
    }

    /**
     * switch Additional Criterion status
     */
    function switchAdditionalCriterion() {
      if ($('#evaluate-level').val().indexOf('AAA') >= 0) {
        $('#set-additional-criterion').prop('disabled', true);
      } else {
        $('#set-additional-criterion').prop('disabled', false);
      }
    }

    /**
     * Set Additional Criteria
     */
    function onClickSetAdditionalCriterion() {
      google.script.run.openDialogAdditionalCriterion($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * progress indicator
     * @param String buttonId
     * @param String indicatorId
     * @param Bool on
     * @return Void
     */
    function progressIndicator(buttonId, indicatorId, on) {
      if (on) {
        $('#'+buttonId).prop('disabled', true);
        if (indicatorId) {
          var msg = Object.keys(lang.ui).length == 0 ? 'in progress' : lang.ui['in-progress'];
          $('#'+indicatorId).show();
          $('#'+indicatorId).html('<span class="skip">'+msg+'</span>');
        }
      } else {
        $('#'+buttonId).prop('disabled', false);
        if (indicatorId) {
          $('#'+indicatorId).hide();
          $('#'+indicatorId).html('');
        }
      }
    }

    /**
     * Generate Icl Template Sheets
     */
    function onClickGenarateIclTpl() {
      progressIndicator('generate-icl-tpl-sheet', 'progress-generate-icl-tpl-sheet', true);
      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
            progressIndicator('generate-icl-tpl-sheet', 'progress-generate-icl-tpl-sheet', false);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg);
            progressIndicator('generate-icl-tpl-sheet', 'progress-generate-icl-tpl-sheet', false);
          })
        .generateIclTplSheet($('#evaluate-level').val());
    }

    /**
     * Apply Icl Template
     */
    function onClickApplyIclTpl() {
      var msg = Object.keys(lang.ui).length == 0 ? 'This action cannot revert.' : lang.ui['apply-icl-tpl-exp'];
      if (confirm(msg) === false) return;
      progressIndicator('apply-icl-tpl', 'progress-apply-icl-tpl', true);
      
      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
            progressIndicator('apply-icl-tpl', 'progress-apply-icl-tpl', false);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg);
            progressIndicator('apply-icl-tpl', 'progress-apply-icl-tpl', false);
          })
        .applyIclSheet();
    }

    /**
     * Generate Sheets
     * @param Object sheetsObj
     */
    function onClickGenerateSheet(sheetsObj) {
      var sheets = sheetsObj.data.sheets;
      var targetId = sheetsObj.data.targetId;
      progressIndicator(targetId, 'progress-'+targetId, true);

      google.script.run
        .withSuccessHandler(
          function(rets) {
            showStatus(rets['msg']);
            progressIndicator(rets['targetId'], 'progress-'+rets['targetId'], false);
          })
        .withFailureHandler(
          function(rets) {
            showStatus(rets['msg']);
            progressIndicator(rets['targetId'], 'progress-'+rets['targetId'], false);
          })
        .generateSheets(sheets, $('#lang').val(), $('#test-type').val(), $('#evaluate-level').val(), targetId);
    }

    /**
     * Generate Url List Sheets
     */
    function onClickGenarateUrlList() {
      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg);
          })
        .generateUrlListSheet($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Edit Value
     */
    function onClickDoapplyAllToT() {
      progressIndicator('do-set-all-t', 'progress-set-all-t', true);

      var msg = Object.keys(lang.ui).length == 0 ? 'This Page\'s All "Check will be overwritten."' : lang.ui['this-pages-all-check-will-be-overwritten'];
      if (confirm(msg) === false) return;

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
            progressIndicator('do-set-all-t', 'progress-set-all-t', false);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg);
            progressIndicator('do-set-all-t', 'progress-set-all-t', false);
          })
        .applyAllToT($('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * show Tech dialog
     */
    function onClickDoInsertTech() {
      google.script.run
        .withSuccessHandler(
          function(criterion) {
            var msg1 = Object.keys(lang.ui).length == 0 ? 'No appropriate criterion found.' : lang.ui['no-criterion-found'];
            var msg2 = Object.keys(lang.ui).length == 0 ? 'Techniques for '+criterion : lang.ui['tech-for'].replace("%s", criterion);
            var title = criterion == '' ? msg1 : msg2 ;
            google.script.run.showDialog('ui-tech', 500, 400, title);
          })
        .getFirstColumn();
    }

    /**
     * Get Current position
     */
    function onClickGetCurrentPos() {
      google.script.run
        .withSuccessHandler(
          function(pos) {
          alert(pos);
            $('#lump-pos-row').val(pos[0]);
            $('#lump-pos-col').val(pos[1]);
            $('#lump-val').val(pos[2]);
          })
        .getCurrentPos();
    }

    /**
     * Do Lump Edit
     */
    function onClickDoLumpEdit() {
      var msg = Object.keys(lang.ui).length == 0 ? 'CAUTION: All result will be overwritten.' : lang.ui['template-caution'];
      if (confirm(msg) === false) return;
      progressIndicator('do-lump-edit', 'progress-do-lump-edit', true);
      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
            progressIndicator('do-lump-edit', 'progress-do-lump-edit', false);
          })
        .doLumpEdit($('#lump-pos-row').val(), $('#lump-pos-col').val(), $('#lump-val').val());
    }

    /**
     * show Screenshot dialog
     */
    function onClickAddScreenshot() {
      var title = Object.keys(lang.ui).length == 0 ? 'Screenshot' : lang.ui['screenshot'];
      google.script.run.showDialog('ui-screenshot', 300, 200, title);
    }

    /**
     * Add Issue
     */
    function onClickAddEditIssue() {
      google.script.run.openDialogIssue($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Show Issue
     */
    function onClickShowIssue() {
      var title = Object.keys(lang.ui).length == 0 ? 'Issue List"' : lang.ui['issue-list'];
      google.script.run.showDialog('ui-issuelist', 500, 400, title);
    }

    /**
     * Make same as template
     */
    function onClickDoTemplateApplyAll() {
      $('#do-template-apply-all').prop('disabled', true);
      var msg = Object.keys(lang.ui).length == 0 ? 'CAUTION: All result will be overwritten.' : lang.ui['caution-using-template'];
      if (confirm(msg) === false) return;

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
            $('#do-template-apply-all').prop('disabled', false);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg);
            $('#do-template-apply-all').prop('disabled', false);
          })
        .templateApplyAll();
    }

    /**
     * Make same as template row
     */
    function onClickDoTemplateApplyRow() {
      $('#do-template-apply-row').prop('disabled', true);
      var msg = Object.keys(lang.ui).length == 0 ? 'CAUTION: All result will be overwritten.' : lang.ui['caution-using-template'];
      if (confirm(msg) === false) return;

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
            $('#do-template-apply-row').prop('disabled', false);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg);
            $('#do-template-apply-row').prop('disabled', false);
          })
        .templateApplyRow();
    }

    /**
     * Evaluate
     */
    function onClickDoEvaluate() {
      progressIndicator('do-evaluate', 'progress-do-evaluate', true);

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('do-evaluate', 'progress-do-evaluate', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('do-evaluate', 'progress-do-evaluate', false);
          })
        .evaluate($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Evaluate ICL
     */
    function onClickDoEvaluateIcl() {
      progressIndicator('do-evaluate-icl', 'progress-do-evaluate-icl', true);

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('do-evaluate-icl', 'progress-do-evaluate-icl', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('do-evaluate-icl', 'progress-do-evaluate-icl', false);
          })
        .evaluateIcl($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Export Rsult
     */
    function onClickExportResult() {
      progressIndicator('export-result', 'progress-export-result', true);

      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('export-result', 'progress-export-result', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('export-result', 'progress-export-result', false);
          })
        .exportResult($('#lang').val(), $('#test-type').val(), $('#evaluate-level').val());
    }

    /**
     * Export Issue
     */
    function onClickExportIssue() {
      progressIndicator('export-issue', 'progress-export-issue', true);
      
      google.script.run
        .withSuccessHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('export-issue', 'progress-export-issue', false);
          })
        .withFailureHandler(
          function(msg, element) {
            showStatus(msg);
            progressIndicator('export-issue', 'progress-export-issue', false);
          })
        .exportIssue();
    }

    /**
     * Show Status
     */
    function showStatus(msg) {
      alert(msg);
    }

    /**
     * reset sheets
     * @param Object obj
     */
    function onClickResetSheets(obj) {
      var isAll = obj.data.isAll;
      if (confirm('Reset Sheets?') === false) return;

      google.script.run
        .withSuccessHandler(
          function(msg) {
            showStatus(msg);
          })
        .withFailureHandler(
          function(msg) {
            showStatus(msg);
          })
        .resetSheets(isAll);
    }
  </script>

  <?!= HtmlService.createHtmlOutputFromFile('ui-css').getContent(); ?>
</head>

<body>
  <details open>
    <summary id="test-type-title">Test type</summary>
    <p>
      <select id="lang" title="Language" style="width:3.5em;min-width:3.5em;">
        <option value="en">en</option>
        <option value="ja">ja</option>
      </select>
      <select id="test-type" title="Test Type">
        <option value="wcag20">WCAG 2.0</option>
        <option value="wcag21">WCAG 2.1</option>
        <option value="tt20">Trusted Tester</option>
        <!--  <option value="tt21">Trusted Tester (WCAG 2.1)</option>-->
      </select>
      <select id="evaluate-level" title="Level" style="width:5em;min-width:5em;">
        <option value="A">A</option>
        <option value="AA">AA</option>
        <option value="AAA">AAA</option>
      </select>
    </p>
    <p><button id="set-additional-criterion">Set additional criteria</button></p>
  </details>
  
  <details>
    <summary id="target-urls-setting">Target URLs Setting</summary>
    <p>
      <button id="generate-url-list-sheet">Generate url list sheet</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-generate-url-list-sheet"></span>
    </p>
    <p>
      <button id="generate-each-record-sheets">Generate each record sheets</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-generate-each-record-sheets"></span>
    </p>
  </details>
  
  <details id="control-icl">
    <summary id="title-icl">ICL</summary>
    <p>
      <button id="generate-icl-tpl-sheet">Generate ICL Sheet</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-generate-icl-tpl-sheet"></span>
    </p>
    <p>
      <button id="apply-icl-tpl">Apply ICL Sheet</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-apply-icl-tpl"></span>
    </p>
  </details>
  
  <details>
    <summary id="title-template">Template</summary>
    <p><button id="generate-template">Generate template sheet</button></p>
    <p><button id="do-template-apply-all">Apply all</button></p>
    <p><button id="do-template-apply-row">Apply current row</button></p>
  </details>
  
  <details>
    <summary id="title-value">Value</summary>
    <p><button id="add-screenshot">Add screenshot</button></p>
    <p>
      <button id="do-set-all-t">Set all to 'T'</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-set-all-t"></span>
    </p>
    <p><button id="do-insert-tech">Insert Techs to sheet</button></p>
    <fieldset>
      <legend id="title-lump-edit">Lump Edit</legend>
      <p>
        <label for="lump-pos-row" id="label-lump-pos-row">X</label>: <input type="text" size="3" id="lump-pos-row">
        <label for="lump-pos-col" id="label-lump-pos-col">Y</label>: <input type="text" size="3" id="lump-pos-col">
        <label for="lump-val" id="label-lump-val">Val</label>: <input type="text" size="7" id="lump-val">
      </p>
      <button id="get-current-pos">Get Current Position</button>
      <button id="do-lump-edit">Apply</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-do-lump-edit"></span>
    </fieldset>
  </details>
  
  <details>
    <summary id="title-issue-control">Issue Control</summary>
    <p><button id="add-edit-issue">Add/Edit Issue</button></p>
    <p><button id="show-issue">Show Issue</button></p>
  </details>
    
  <details>
    <summary id="title-evaluate">Evaluate</summary>
    <p>
      <button id="do-evaluate">Evaluate</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-do-evaluate"></span>
    </p>
    <p>
      <button id="do-evaluate-icl">Evaluate ICL</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-do-evaluate-icl"></span>
    </p>
  </details>
  
  <details>
    <summary id="export-html-title">Export as HTML</summary>
    <p>
      <button id="export-result">Export Result</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-export-result"></span>
    </p>
    <p>
      <button id="export-issue">Export Issues</button>
      <span role="region" aria-live="polite" class="fa fa-spinner fa-spin" id="progress-export-issue"></span>
    </p>
  </details>
  
  <div id="dev">
    <details>
    <summary>Developer Only</summary>
    <p><button id="reset-record-sheets">Reset Record Sheet</button></p>
    <p><button id="reset-sheets">Reset All</button></p>
    </details>
  </div>
</body>

</html>
